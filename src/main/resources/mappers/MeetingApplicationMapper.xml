<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hj.lunchExpedition.meeting.mapper.MeetingApplicationMapper">

    <!-- 특정 모임 신청자 목록 조회 -->
    <select id="selectApplicantsByMeeting" resultType="com.hj.lunchExpedition.meeting.dto.MeetingApplicantRDto">
        SELECT
        ma.id,
        ma.applicant_id AS applicantId,
        u.nickname,
        u.self_introduction AS selfIntroduction,
        ma.status,
        ma.applied_at AS appliedAt,
        ma.responded_at AS respondedAt
        FROM meeting_application ma
        LEFT JOIN user u ON ma.applicant_id = u.id
        WHERE ma.meeting_id = #{meetingId}
        AND EXISTS (
            SELECT 1
            FROM meeting m
            WHERE m.id = ma.meeting_id
            AND m.host_id = #{hostId}
        )
        ORDER BY ma.applied_at DESC
    </select>

    <!-- 신청 승인/거절 업데이트 -->
    <update id="updateApplicationStatus">
        UPDATE meeting_application ma
        SET
        status = #{status},
        responded_at = NOW()
        WHERE ma.meeting_id = #{meetingId}
        AND ma.applicant_id = #{applicantId}
        AND ma.status = 'PENDING'
        AND EXISTS (
            SELECT 1
            FROM meeting m
            WHERE m.id = ma.meeting_id
            AND m.host_id = #{hostId}
        )
    </update>

</mapper>
